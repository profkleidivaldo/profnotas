<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Espelho de Notas — Professor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
body{font-family:Arial;max-width:1400px;margin:auto;padding:20px}
h2{text-align:center}
.tabs button{padding:8px;border:none;margin-right:4px;cursor:pointer}
.tabs .ativo{background:#1976d2;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{border:1px solid #000;padding:4px;text-align:center}
th{background:#f0f0f0}
input,textarea{width:100%;border:none;text-align:center}
textarea{border:1px solid #000;margin-top:6px}
button.acao{background:#1976d2;color:#fff;border:none;padding:10px;margin-top:8px;cursor:pointer}
</style>
</head>

<body>

<h2>Espelho de Notas — Registro Anual</h2>

<label>Turma</label>
<input id="turma">

<div class="tabs">
  <button onclick="mudarBimestre(1)" class="ativo">1º BIM</button>
  <button onclick="mudarBimestre(2)">2º BIM</button>
  <button onclick="mudarBimestre(3)">3º BIM</button>
  <button onclick="mudarBimestre(4)">4º BIM</button>
</div>

<label>Colar dados do Excel (tabela completa)</label>
<textarea id="excel" rows="5"
placeholder="Nº | Nome | LP | Arte | EF | ER | MAT | GEO | HIS | CIE | Faltas"></textarea>

<button class="acao" onclick="importarExcel()">Importar do Excel</button>
<button class="acao" onclick="salvarBimestre()">Salvar Bimestre</button>
<button class="acao" onclick="gerarArquivo()">Gerar Arquivo Criptografado</button>

<table>
<thead>
<tr>
  <th>Nº</th><th>ESTUDANTE</th>
  <th>LP</th><th>ARTE</th><th>EF</th><th>ER</th>
  <th>MAT</th><th>GEO</th><th>HIS</th><th>CIE</th>
  <th>FALTAS</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
let bimestreAtual=1;
let dados=JSON.parse(localStorage.getItem("espelhoDados"))||{};
const tbody=document.getElementById("tbody");

function salvarLocal(){
  localStorage.setItem("espelhoDados",JSON.stringify(dados));
}

function mudarBimestre(b){
  bimestreAtual=b;
  document.querySelectorAll(".tabs button").forEach(btn=>btn.classList.remove("ativo"));
  document.querySelectorAll(".tabs button")[b-1].classList.add("ativo");
  carregarTabela();
}

function criarLinha(i,val={}){
  const tr=document.createElement("tr");
  tr.innerHTML=`
<td>${i}</td>
<td><input value="${val.nome||""}"></td>
<td><input value="${val.LP||""}"></td>
<td><input value="${val.ARTE||""}"></td>
<td><input value="${val.EF||""}"></td>
<td><input value="${val.ER||""}"></td>
<td><input value="${val.MAT||""}"></td>
<td><input value="${val.GEO||""}"></td>
<td><input value="${val.HIS||""}"></td>
<td><input value="${val.CIE||""}"></td>
<td><input value="${val.FALTAS||""}"></td>`;
  tbody.appendChild(tr);
}

function carregarTabela(){
  tbody.innerHTML="";
  for(let i=1;i<=30;i++){
    const a=dados[i];
    const b=a?.bimestres?.[bimestreAtual]||{};
    criarLinha(i,{nome:a?.nome,...b});
  }
}

function importarExcel(){
  const linhas=document.getElementById("excel").value.trim().split(/\r?\n/);
  linhas.forEach(l=>{
    const c=l.split("\t");
    const i=parseInt(c[0]);
    if(!i||!c[1]) return;
    if(!dados[i]) dados[i]={nome:c[1],bimestres:{}};
    dados[i].nome=c[1];
    dados[i].bimestres[bimestreAtual]={
      LP:c[2],ARTE:c[3],EF:c[4],ER:c[5],
      MAT:c[6],GEO:c[7],HIS:c[8],CIE:c[9],FALTAS:c[10]
    };
  });
  salvarLocal();
  carregarTabela();
  document.getElementById("excel").value="";
}

function salvarBimestre(){
  [...tbody.rows].forEach((tr,i)=>{
    const c=[...tr.querySelectorAll("input")];
    if(!c[0].value) return;
    if(!dados[i+1]) dados[i+1]={nome:c[0].value,bimestres:{}};
    dados[i+1].nome=c[0].value;
    dados[i+1].bimestres[bimestreAtual]={
      LP:c[1].value,ARTE:c[2].value,EF:c[3].value,ER:c[4].value,
      MAT:c[5].value,GEO:c[6].value,HIS:c[7].value,CIE:c[8].value,
      FALTAS:c[9].value
    };
  });
  salvarLocal();
  alert("Bimestre salvo");
}

function gerarArquivo(){
  const registros=[];
  Object.values(dados).forEach(a=>{
    const medias={};
    ["LP","ARTE","EF","ER","MAT","GEO","HIS","CIE"].forEach(d=>{
      let s=0,q=0;
      for(let b in a.bimestres){
        if(a.bimestres[b][d]){
          s+=Number(a.bimestres[b][d]); q++;
        }
      }
      medias[d]=q?(s/q).toFixed(1):"";
    });
    const payload={...a,medias};
    registros.push({
      nome:a.nome,
      dados:CryptoJS.AES.encrypt(JSON.stringify(payload),a.nome.toLowerCase()).toString()
    });
  });
  const js=`window.DADOS_ESCOLA=${JSON.stringify(registros,null,2)};`;
  const blob=new Blob([js],{type:"application/javascript"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="dados_turma.js";
  a.click();
}

carregarTabela();
</script>

</body>
</html>
